<!doctype html>
<html lang="en-US">
    <head>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js?ver=3.3.1"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha256-1A78rJEdiWTzco6qdn3igTBv9VupN3Q1ozZNTR4WE/Y=" crossorigin="anonymous"></script>
    </head>
    <body>
        <script>

            let BrowserDetect = {
                init: function () {
                    this.browser = this.searchString(this.dataBrowser) || "An unknown browser";
                    this.version = this.searchVersion(navigator.userAgent)
                        || this.searchVersion(navigator.appVersion)
                        || "an unknown version";
                    this.OS = this.searchString(this.dataOS) || "an unknown OS";
                },
                searchString: function (data) {
                    for (var i=0;i<data.length;i++)	{
                        var dataString = data[i].string;
                        var dataProp = data[i].prop;
                        this.versionSearchString = data[i].versionSearch || data[i].identity;
                        if (dataString) {
                            if (dataString.indexOf(data[i].subString) != -1)
                                return data[i].identity;
                        }
                        else if (dataProp)
                            return data[i].identity;
                    }
                },
                searchVersion: function (dataString) {
                    var index = dataString.indexOf(this.versionSearchString);
                    if (index == -1) return;
                    return parseFloat(dataString.substring(index+this.versionSearchString.length+1));
                },
                dataBrowser: [
                    {
                        string: navigator.userAgent,
                        subString: "Chrome",
                        identity: "Chrome"
                    },
                    { 	string: navigator.userAgent,
                        subString: "OmniWeb",
                        versionSearch: "OmniWeb/",
                        identity: "OmniWeb"
                    },
                    {
                        string: navigator.vendor,
                        subString: "Apple",
                        identity: "Safari",
                        versionSearch: "Version"
                    },
                    {
                        prop: window.opera,
                        identity: "Opera"
                    },
                    {
                        string: navigator.vendor,
                        subString: "iCab",
                        identity: "iCab"
                    },
                    {
                        string: navigator.vendor,
                        subString: "KDE",
                        identity: "Konqueror"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "Firefox",
                        identity: "Firefox"
                    },
                    {
                        string: navigator.vendor,
                        subString: "Camino",
                        identity: "Camino"
                    },
                    {		// for newer Netscapes (6+)
                        string: navigator.userAgent,
                        subString: "Netscape",
                        identity: "Netscape"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "MSIE",
                        identity: "Explorer",
                        versionSearch: "MSIE"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "Gecko",
                        identity: "Mozilla",
                        versionSearch: "rv"
                    },
                    { 		// for older Netscapes (4-)
                        string: navigator.userAgent,
                        subString: "Mozilla",
                        identity: "Netscape",
                        versionSearch: "Mozilla"
                    }
                ],
                dataOS : [
                    {
                        string: navigator.platform,
                        subString: "Win",
                        identity: "Windows"
                    },
                    {
                        string: navigator.platform,
                        subString: "Mac",
                        identity: "Mac"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "iPhone",
                        identity: "iPhone/iPod"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "iPad",
                        identity: "iPad"
                    },
                    {
                        string: navigator.platform,
                        subString: "Linux",
                        identity: "Linux"
                    }
                ]

            };
            BrowserDetect.init();
            
            let LNCAnalytics = {
                domain: (document.location.href.indexOf("localhost") > -1) ? "http://localhost:5000" : "https://lnc-analytics.herokuapp.com",

                session_id: $.cookie('lnc_session_id'),
                page_id: '',
                session_data: {},
                page_data: {},
                done: false,

                init: function(){
                    if(this.session_id === undefined){
                        this.open_session();
                    }else{
                        this.verify_session();
                    }

                    this.get_page_info_from_ip();
                },
                
                open_session: function () {
                    $.ajax({
                        type:		'GET',
                        url:		this.domain + '/session/open',
                        success:	function(value){
                            $.cookie('lnc_session_id', value, { expires: 730, path: '/' });
                            LNCAnalytics.session_id = value;
                            LNCAnalytics.get_session_info();
                        }
                    });
                },

                verify_session: function () {
                    $.ajax({
                        type:		'GET',
                        url:		this.domain + '/session/verify/' + this.session_id,
                        success:	function(value){
                            if(value !== "true"){
                                LNCAnalytics.open_session();
                            }
                        }
                    });
                },

                get_session_info: function () {
                    this.session_data["timeZone"] = new Date().getTimezoneOffset();
                    this.session_data["language"] = navigator.language || navigator.userLanguage;

                    this.session_data["software"] = {};

                    this.session_data["software"]["os"] = {};
                    this.session_data["software"]["os"]["vendor"] = BrowserDetect.OS;

                    this.session_data["software"]["browser"] = {};
                    this.session_data["software"]["browser"]["vendor"] = BrowserDetect.browser;
                    this.session_data["software"]["browser"]["version"] = BrowserDetect.version;
                    
                    this.session_data["display"] = {};
                    this.session_data["display"]["scale"] = window.devicePixelRatio;
                    this.session_data["display"]["width"] = window.screen.width;
                    this.session_data["display"]["height"] = window.screen.height;
                    this.session_data["display"]["colorDepth"] = window.screen.colorDepth;

                    this.send_session_data(this.session_data);
                },

                send_session_data: function (data) {
                    $.ajax({
                        type:       'PUT',
                        data:       data,
                        url:        this.domain + '/session/update/' + this.session_id,
                        success:    function(response){
                            console.log("Session data sent");
                        }
                    });
                },
                
                get_page_info_from_ip: function () {
                    $.get("https://ipinfo.io", function(response) {
                        
                        const loc = response.loc.split(',');

                        LNCAnalytics.page_data["network"] = {};
                        LNCAnalytics.page_data["network"]["publicIP"] = response.ip;
                        LNCAnalytics.page_data["network"]["provider"] = response.org;

                        LNCAnalytics.page_data["location"] = {};
                        LNCAnalytics.page_data["location"]["latitude"] = loc[0];
                        LNCAnalytics.page_data["location"]["longitude"] = loc[1];
                        LNCAnalytics.page_data["location"]["country"] = response.country;
                        LNCAnalytics.page_data["location"]["region"] = response.region;
                        LNCAnalytics.page_data["location"]["postal"] = response.postal;
                        LNCAnalytics.page_data["location"]["city"] = response.city;
                        
                        LNCAnalytics.send_page_data(this.page_data);

                    }, "jsonp");
                },
                
                get_page_info_from_parent: function (data) {
                
                    this.page_data['referrer'] = data.referrer;
                    this.page_data['host'] = data.host;
                    this.page_data['path'] = data.path;

                    this.page_data['document'] = {};
                    this.page_data['document']['title'] = data.title;
                    this.page_data['document']['width'] = data.width;
                    this.page_data['document']['height'] = data.height;

                    this.send_page_data(this.page_data);
                },

                send_page_data: function (data) {
                    if(!this.done){this.done=true;return;}

                    $.ajax({
                        type:       'PUT',
                        data:       data,
                        url:        this.domain + '/page/open/' + this.session_id,
                        success:    function(response){
                            LNCAnalytics.page_id = response;
                            setTimeout(function(){
                                LNCAnalytics.send_beacon();
                            },5000);
                        }
                    });
                },

                send_beacon: function () {
                    setInterval(function(){
                        $.ajax({
                            type:       'PUT',
                            url:        LNCAnalytics.domain + '/page/close/' + LNCAnalytics.page_id,
                        });
                    }, 2000);
                },

                send_contact: function (data){
                    let contact_data = {}

                    contact_data["origin"] = data.origin;
                    contact_data["firstname"] = data.firstname;
                    contact_data["lastname"] = data.lastname;
                    contact_data["email"] = data.email;
                    contact_data["phone"] = data.phone;
                    contact_data["message"] = data.message;

                    $.ajax({
                        type:       'PUT',
                        url:        this.domain + '/contact/' + this.session_id,
                        data:       contact_data,
                    });
                },

                message: function (message){
                    if(message.type === "init"){
                        this.get_page_info_from_parent(message.data);
                    }else if(message.type === "contact"){
                        this.send_contact(message.data);
                    }
                }
            }
            LNCAnalytics.init();
            window.addEventListener('message', function(e){LNCAnalytics.message(e.data)}, false);
            
        </script>
    </body>
</html>