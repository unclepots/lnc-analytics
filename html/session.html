<!doctype html>
<html lang="en-US">
    <head>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js?ver=3.3.1"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha256-1A78rJEdiWTzco6qdn3igTBv9VupN3Q1ozZNTR4WE/Y=" crossorigin="anonymous"></script>
    </head>
    <body>
        <script>
            let domain = (document.location.href.indexOf("localhost") > -1) ? "http://localhost:5000" : "https://lnc-analytics.herokuapp.com";
            let session_id = $.cookie('lnc_session_id');
            let session_data = {};
            let page_data = {};
            let page_id = '';
            let done = false;

            var BrowserDetect = {
                init: function () {
                    this.browser = this.searchString(this.dataBrowser) || "An unknown browser";
                    this.version = this.searchVersion(navigator.userAgent)
                        || this.searchVersion(navigator.appVersion)
                        || "an unknown version";
                    this.OS = this.searchString(this.dataOS) || "an unknown OS";
                },
                searchString: function (data) {
                    for (var i=0;i<data.length;i++)	{
                        var dataString = data[i].string;
                        var dataProp = data[i].prop;
                        this.versionSearchString = data[i].versionSearch || data[i].identity;
                        if (dataString) {
                            if (dataString.indexOf(data[i].subString) != -1)
                                return data[i].identity;
                        }
                        else if (dataProp)
                            return data[i].identity;
                    }
                },
                searchVersion: function (dataString) {
                    var index = dataString.indexOf(this.versionSearchString);
                    if (index == -1) return;
                    return parseFloat(dataString.substring(index+this.versionSearchString.length+1));
                },
                dataBrowser: [
                    {
                        string: navigator.userAgent,
                        subString: "Chrome",
                        identity: "Chrome"
                    },
                    { 	string: navigator.userAgent,
                        subString: "OmniWeb",
                        versionSearch: "OmniWeb/",
                        identity: "OmniWeb"
                    },
                    {
                        string: navigator.vendor,
                        subString: "Apple",
                        identity: "Safari",
                        versionSearch: "Version"
                    },
                    {
                        prop: window.opera,
                        identity: "Opera"
                    },
                    {
                        string: navigator.vendor,
                        subString: "iCab",
                        identity: "iCab"
                    },
                    {
                        string: navigator.vendor,
                        subString: "KDE",
                        identity: "Konqueror"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "Firefox",
                        identity: "Firefox"
                    },
                    {
                        string: navigator.vendor,
                        subString: "Camino",
                        identity: "Camino"
                    },
                    {		// for newer Netscapes (6+)
                        string: navigator.userAgent,
                        subString: "Netscape",
                        identity: "Netscape"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "MSIE",
                        identity: "Explorer",
                        versionSearch: "MSIE"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "Gecko",
                        identity: "Mozilla",
                        versionSearch: "rv"
                    },
                    { 		// for older Netscapes (4-)
                        string: navigator.userAgent,
                        subString: "Mozilla",
                        identity: "Netscape",
                        versionSearch: "Mozilla"
                    }
                ],
                dataOS : [
                    {
                        string: navigator.platform,
                        subString: "Win",
                        identity: "Windows"
                    },
                    {
                        string: navigator.platform,
                        subString: "Mac",
                        identity: "Mac"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "iPhone",
                        identity: "iPhone/iPod"
                    },
                    {
                        string: navigator.userAgent,
                        subString: "iPad",
                        identity: "iPad"
                    },
                    {
                        string: navigator.platform,
                        subString: "Linux",
                        identity: "Linux"
                    }
                ]

            };
            BrowserDetect.init();
            
            window.addEventListener('message', function(e){
                if(e.data.type === "init"){
                    page_add_from_parent(e.data.data);
                }else if(e.data.type === "contact"){
                    send_contact(e.data.data);
                }
            }, false);

            function open_session(){
                "use strict";

                $.ajax({
                    type:		'GET',
                    url:		domain + '/session/open',
                    success:	function(value){
                        $.cookie('lnc_session_id', value, { expires: 730, path: '/' });
                        session_id = value;
                        get_session_info();
                    }
                });
            }
            
            function verify_session(session_id){
                "use strict";

                $.ajax({
                    type:		'GET',
                    url:		domain + '/session/verify/'+session_id,
                    success:	function(value){
                        if(value !== "true"){
                            //console.log("Session Not Verified");
                            open_session();
                        }
                    }
                });
            }
            
            function send_session_date(data){
                "use strict";
                $.ajax({
                    type:       'PUT',
                    data:       data,
                    url:        domain + '/session/update/' + session_id,
                    success:    function(response){
                        //console.log(response);
                    }
                });
            }

            function get_session_info(){
                "use strict";

                session_data["timeZone"] = new Date().getTimezoneOffset();
                session_data["language"] = navigator.language || navigator.userLanguage;

                session_data["software"] = {};

                session_data["software"]["os"] = {};
                session_data["software"]["os"]["vendor"] = BrowserDetect.OS;

                session_data["software"]["browser"] = {};
                session_data["software"]["browser"]["vendor"] = BrowserDetect.browser;
                session_data["software"]["browser"]["version"] = BrowserDetect.version;
                
                session_data["display"] = {};
                session_data["display"]["scale"] = window.devicePixelRatio;
                session_data["display"]["width"] = window.screen.width;
                session_data["display"]["height"] = window.screen.height;
                session_data["display"]["colorDepth"] = screen.colorDepth;

                send_session_date(session_data);
            }
            
            function page_add_from_parent(data){
                
                page_data['referrer'] = data.referrer;
                page_data['host'] = data.host;
                page_data['page'] = data.page;

                page_data['document'] = {};
                page_data['document']['title'] = data.title;
                page_data['document']['width'] = data.width;
                page_data['document']['height'] = data.height;

                submit_page_visit(page_data);
            }

            function get_page_view(){
                "use strict";

                $.get("https://ipinfo.io", function(response) {
                    
                    page_data["network"] = {};
                    page_data["network"]["publicIP"] = response.ip;
                    page_data["network"]["provider"] = response.org;

                    page_data["location"] = {};
                    const loc = response.loc.split(',');
                    page_data["location"]["latitude"] = loc[0];
                    page_data["location"]["longitude"] = loc[1];
                    page_data["location"]["country"] = response.country;
                    page_data["location"]["region"] = response.region;
                    page_data["location"]["postal"] = response.postal;
                    page_data["location"]["city"] = response.city;
                    
                    submit_page_visit(page_data);

                }, "jsonp");
            }
            
            function submit_page_visit(data){
                if(!done){done=true;return;}
                "use strict";
                $.ajax({
                    type:       'PUT',
                    data:       data,
                    url:        domain + '/page/open/' + session_id,
                    success:    function(response){
                        page_id = response;
                        send_beacon();
                    }
                });
            }
            
            function send_contact(data){
                "use strict";

                let contact_data = {}

                contact_data["origin"] = data.origin;
                contact_data["firstname"] = data.firstname;
                contact_data["lastname"] = data.lastname;
                contact_data["email"] = data.email;
                contact_data["phone"] = data.phone;
                contact_data["message"] = data.message;

                $.ajax({
                    type:       'PUT',
                    url:        domain + '/contact/' + session_id,
                    data: contact_data,
                    success:    function(response){
                        console.log(response);
                    }
                });
            }

            function send_beacon(){
                "use strict";
                setInterval(function(){
                    $.ajax({
                        type:       'PUT',
                        url:        domain + '/page/close/' + page_id,
                        success:    function(response){
                            console.log(response);
                        }
                    });
                }, 1000);
            };
            
            if(session_id === undefined){
                open_session();
                //console.log("Session Set");
            }else{
                //console.log("Session Verify");
                verify_session(session_id);
            }

            get_page_view();
        </script>
    </body>
</html>