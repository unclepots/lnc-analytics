<!doctype html>
<html lang="en-US">
    <head>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js?ver=3.3.1"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha256-1A78rJEdiWTzco6qdn3igTBv9VupN3Q1ozZNTR4WE/Y=" crossorigin="anonymous"></script>
    </head>
    <body>
        <script>
            let domain = (document.location.href.indexOf("localhost") > -1) ? "http://localhost:5000" : "https://lnc-analytics.herokuapp.com";
            let session_id = $.cookie('lnc_session_id');
            let session_data = {};
            
            function get_os(){
                var OSName="Unknown OS";
                if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
                if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
                if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
                if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";
                return OSName;
            }

            function get_browser(){
                var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
                var isFirefox = typeof InstallTrigger !== 'undefined';
                var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));
                var isIE = /*@cc_on!@*/false || !!document.documentMode;
                var isEdge = !isIE && !!window.StyleMedia;
                var isChrome = !!window.chrome && !!window.chrome.webstore;

                if(isOpera){return 'Opera';}
                else if(isFirefox){return 'Mozilla';}
                else if(isSafari){return 'Safari';}
                else if(isIE && isEdge){return 'Edge';}
                else if(isIE){return 'IE';}
                else if(isChrome){return 'Chrome';}
                else{return 'Undefined';}
            }

            function open_session(){
                $.ajax({
                    type:		'GET',
                    url:		domain + '/session/open',
                    success:	function(value){
                        $.cookie('lnc_session_id', value, { expires: 365, path: '/' });
                        session_id = value;
                        get_session_info();
                    }
                });
            }
            
            function verify_session(session_id){
                $.ajax({
                    type:		'GET',
                    url:		domain + '/session/verify/'+session_id,
                    success:	function(value){
                        console.log(value);
                        if(value !== "true"){
                            console.log("Session Not Verified");
                            open_session();
                        }
                    }
                });
            }
            
            function send_session_date(data){
                $.ajax({
                    type:       'PUT',
                    data:       data,
                    url:        domain + '/session/update/' + session_id,
                    success:    function(response){
                        console.log(response);
                    }
                });
            }

            function get_session_info(){
                session_data.display = {};

                $.get("https://ipinfo.io", function(response) {

                    session_data["network"] = {};
                    session_data["network"]["public_ip"] = response.ip;
                    session_data["network"]["provider"] = response.org;

                    session_data["location"] = {};
                    loc = response.loc.split(',');
                    session_data["location"]["latitude"] = loc[0];
                    session_data["location"]["longitude"] = loc[1];
                    session_data["location"]["country"] = response.country;
                    session_data["location"]["region"] = response.region;
                    session_data["location"]["postal"] = response.postal;
                    session_data["location"]["city"] = response.city;

                    send_session_date(session_data);
                }, "jsonp");

                session_data["timeZone"] = new Date().getTimezoneOffset();
                session_data["language"] = navigator.language || navigator.userLanguage;

                session_data["software"] = {};
                session_data["software"]["os"] = get_os();
                session_data["software"]["browser"] = get_browser();
                
                session_data["display"] = {};
                session_data["display"]["screenWidth"] = window.screen.width;
                session_data["display"]["screenHeight"] = window.screen.height;
                session_data["display"]["colorDepth"] = screen.colorDepth;
                    
            }


            if(session_id === undefined){
                open_session();
                console.log("Session Set");
            }else{
                console.log("Session Verify");
                verify_session(session_id);
            }
        </script>
    </body>
</html>